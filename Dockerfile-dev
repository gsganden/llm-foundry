FROM mosaicml/llm-foundry:2.6.0_cu124-latest
COPY --from=ghcr.io/astral-sh/uv:0.6.5 /uv /uvx /bin/

LABEL maintainer="Greg Gandenberger <gsganden@gmail.com>"
LABEL description="Development environment for LLM-Foundry"

WORKDIR /llm-foundry

RUN apt-get update \
    && apt-get install -y \
    wget \
    git \
    && rm -rf /var/lib/apt/lists/*

# Copy only the files needed for dependency installation
COPY requirements.txt .

# Install dependencies
RUN --mount=type=cache,target=/root/.cache/uv \
    uv venv --python 3.11.4 \
    && source .venv/bin/activate \
    && uv pip install -r requirements.txt

# Now copy the rest of the application code
COPY . .

# Install llmfoundry in editable mode
RUN source .venv/bin/activate && uv pip install -e .

# Create directory for Hugging Face token and declare it as a volume
RUN mkdir -p /root/.cache/huggingface
VOLUME /root/.cache/huggingface

ENV PATH="/llm-foundry/.venv/bin:$PATH"
